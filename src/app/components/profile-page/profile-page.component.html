<ng-container *transloco="let t; prefix: 'jet-profile-page'">
  <jet-page
    [seoDescription]="t('seo.description')"
    [seoKeywords]="t('seo.keywords')"
    [seoTitle]="t('seo.title')"
    [toolbarTitle]="t('toolbar-title')"
  >
    @let _profile = profile();
    @if (_profile) {
      <div
        style="
          margin: 0 auto;
          max-width: 480px;
          display: flex;
          gap: 16px;
          flex-direction: column;
        "
      >
        <mat-card>
          <img
            [alt]="t('profile')"
            height="180"
            mat-card-image
            ngSrc="./profile.webp"
            priority
            style="object-fit: cover"
            width="480"
          />
          <mat-card-content>
            <mat-card
              (click)="avatarInput.click()"
              matRipple
              style="
                border: 2px solid var(--mat-sys-primary);
                cursor: pointer;
                height: 132px;
                width: 132px;
                border-radius: 50%;
                margin: -100px auto 32px;
              "
            >
              <img
                [alt]="t('avatar')"
                [ngSrc]="_profile.avatar_url"
                height="128"
                priority
                style="object-fit: cover"
                width="128"
              />
              <mat-card-content style="display: none">
                <input
                  #avatarInput
                  [disabled]="profileFormGroup.disabled"
                  (change)="checkAndUploadAvatar()"
                  accept="image/*"
                  type="file"
                />
              </mat-card-content>
            </mat-card>
            <form
              id="profile-form"
              [formGroup]="profileFormGroup"
              (ngSubmit)="
                updateProfile({
                  username: profileFormGroup.controls.username.value ?? '',
                })
              "
            >
              <mat-form-field>
                <mat-label>{{ t('username') }}</mat-label>
                <input
                  autocomplete="username"
                  formControlName="username"
                  matInput
                  required
                  type="text"
                />
                @if (profileFormGroup.controls.username.dirty) {
                  <mat-hint align="end"
                    >{{
                      t('characters', {
                        maximum: 30,
                        value:
                          profileFormGroup.controls.username.value?.length || 0,
                      })
                    }}
                  </mat-hint>
                }
              </mat-form-field>
            </form>
          </mat-card-content>
          <mat-card-actions>
            <button
              [disabled]="
                isUpdateProfilePending ||
                profileFormGroup.invalid ||
                profileFormGroup.pristine
              "
              form="profile-form"
              mat-flat-button
              type="submit"
            >
              <mat-icon>check</mat-icon>
              <span>{{ t('update-profile') }}</span>
            </button>
            <div style="flex: 1"></div>
            <a
              mat-button
              routerLink="/update-password"
            >
              <mat-icon>lock_reset</mat-icon>
              <span>{{ t('update-password') }}</span>
            </a>
          </mat-card-actions>
          <mat-card-footer>
            <mat-progress-bar
              [ngStyle]="{
                visibility: isUpdateProfilePending ? 'visible' : 'hidden',
              }"
              mode="indeterminate"
            ></mat-progress-bar>
          </mat-card-footer>
        </mat-card>
        <mat-card>
          <mat-card-content
            style="font: var(--mat-sys-label-small); text-align: center"
          >
            <div>
              <p>{{ user()?.email }}</p>
              <p>
                {{
                  t('last-updated-on', {
                    value: _profile.updated_at | date: 'fullDate',
                  })
                }}
              </p>
              <p>
                {{
                  t('created-on', {
                    value: _profile.created_at | date: 'fullDate',
                  })
                }}
              </p>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    } @else {
      <div style="display: flex; justify-content: center">
        <mat-progress-spinner
          diameter="32"
          mode="indeterminate"
        ></mat-progress-spinner>
      </div>
    }
  </jet-page>
</ng-container>
